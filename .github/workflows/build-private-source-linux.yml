name: build-private-source-linux

on:
  workflow_dispatch:
    inputs:
      source_repo_ssh_url:
        description: SSH URL for private source repo
        required: true
        type: string
      source_ref:
        description: Source git ref or commit
        required: true
        type: string
      artifact_prefix:
        description: Artifact name prefix
        required: true
        default: gnirehtet-linux-apk
        type: string

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        variant: [debug, release]
    steps:
      - name: Setup Java 17 (for SDK tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Java 11 (for Gradle build)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}

      - name: Add GitHub host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Clone private source
        run: |
          git clone "${{ inputs.source_repo_ssh_url }}" source
          cd source
          git checkout "${{ inputs.source_ref }}"

      - name: Build APK
        run: |
          cd source
          chmod +x tool/ci/build.sh
          ./tool/ci/build.sh "${{ matrix.variant }}" out/artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_prefix }}-${{ matrix.variant }}
          path: source/out/artifacts
          retention-days: 1
          if-no-files-found: error
